{% extends 'index.html' %}

{% block title %}Farmacia | SegPrivado{% endblock %}

{% block extra_head %}
<style>
    .pharmacy-shell {
        display: grid;
        grid-template-columns: minmax(0, 1.35fr) minmax(320px, 0.9fr);
        gap: 14px;
    }

    .pharmacy-stack {
        display: grid;
        gap: 14px;
    }

    .pharmacy-panel {
        display: grid;
        gap: 16px;
    }

    .pharmacy-panel__head {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
    }

    .pharmacy-panel__copy {
        margin: 6px 0 0;
        color: var(--muted);
        line-height: 1.6;
    }

    .pharmacy-pill {
        display: inline-flex;
        align-items: center;
        min-height: 32px;
        padding: 0 11px;
        border-radius: 999px;
        font-size: 0.76rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: var(--primary-deep);
        background: var(--primary-soft);
    }

    .medicine-grid {
        display: grid;
        gap: 12px;
    }

    .medicine-card {
        display: grid;
        gap: 12px;
        padding: 16px;
        border-radius: 18px;
        border: 1px solid rgba(116, 138, 160, 0.14);
        background:
            radial-gradient(circle at top right, rgba(29, 95, 136, 0.08), transparent 28%),
            linear-gradient(180deg, #ffffff, #f8fbfd);
    }

    .medicine-card--disabled {
        opacity: 0.72;
    }

    .medicine-card__top,
    .cart-row__top {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
    }

    .medicine-card__name,
    .cart-row__name {
        margin: 0;
        font-size: 1rem;
        font-weight: 700;
        color: var(--primary-deep);
    }

    .medicine-card__meta,
    .cart-row__meta {
        margin: 4px 0 0;
        color: var(--muted);
        line-height: 1.55;
    }

    .price-tag,
    .stock-tag,
    .summary-stat__value {
        display: inline-flex;
        align-items: center;
        min-height: 34px;
        padding: 0 12px;
        border-radius: 12px;
        font-weight: 700;
    }

    .price-tag {
        color: var(--primary-deep);
        background: rgba(230, 240, 247, 0.78);
    }

    .stock-tag {
        font-size: 0.8rem;
        color: var(--muted);
        background: #f7fafc;
        border: 1px solid rgba(116, 138, 160, 0.14);
    }

    .stock-tag--low {
        color: #8b5a18;
        background: #fff7e8;
        border-color: rgba(212, 161, 72, 0.18);
    }

    .stock-tag--empty {
        color: var(--danger);
        background: #fff1f1;
        border-color: rgba(180, 71, 71, 0.14);
    }

    .medicine-card__foot {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
    }

    .cart-list {
        display: grid;
        gap: 12px;
    }

    .cart-row {
        display: grid;
        gap: 12px;
        padding: 15px;
        border-radius: 16px;
        border: 1px solid rgba(116, 138, 160, 0.14);
        background: linear-gradient(180deg, #ffffff, #fbfdff);
    }

    .cart-row__qty {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 36px;
        min-height: 36px;
        padding: 0 10px;
        border-radius: 12px;
        font-weight: 700;
        color: #ffffff;
        background: linear-gradient(135deg, var(--primary), var(--primary-deep));
    }

    .cart-row__totals {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .cart-row__actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .summary-card {
        position: sticky;
        top: 92px;
        display: grid;
        gap: 16px;
        padding: 18px;
        border-radius: 22px;
        border: 1px solid rgba(29, 95, 136, 0.12);
        background:
            radial-gradient(circle at top right, rgba(29, 95, 136, 0.12), transparent 30%),
            linear-gradient(180deg, #ffffff, #f7fbfe);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.76);
    }

    .summary-card__head {
        display: grid;
        gap: 6px;
    }

    .summary-card__eyebrow {
        display: inline-flex;
        align-items: center;
        width: fit-content;
        min-height: 30px;
        padding: 0 11px;
        border-radius: 999px;
        font-size: 0.74rem;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--primary-deep);
        background: rgba(230, 240, 247, 0.82);
    }

    .summary-card__title {
        margin: 0;
        font-size: 1.15rem;
        font-weight: 700;
        color: var(--primary-deep);
    }

    .summary-card__copy {
        margin: 0;
        color: var(--muted);
        line-height: 1.6;
    }

    .summary-grid {
        display: grid;
        gap: 10px;
    }

    .summary-stat {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 12px 13px;
        border-radius: 15px;
        border: 1px solid rgba(116, 138, 160, 0.12);
        background: rgba(255, 255, 255, 0.86);
    }

    .summary-stat__label {
        font-size: 0.82rem;
        font-weight: 700;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: var(--muted);
    }

    .summary-stat__value {
        color: var(--primary-deep);
        background: rgba(230, 240, 247, 0.7);
    }

    .summary-stat__value--total {
        color: #ffffff;
        background: linear-gradient(135deg, var(--primary), var(--primary-deep));
    }

    .summary-notes {
        display: grid;
        gap: 10px;
        margin: 0;
        padding: 0;
        list-style: none;
    }

    .summary-notes li {
        padding: 12px 13px;
        border-radius: 14px;
        color: var(--muted);
        line-height: 1.55;
        background: rgba(255, 255, 255, 0.82);
        border: 1px solid rgba(116, 138, 160, 0.12);
    }

    .summary-actions {
        display: grid;
        gap: 10px;
    }

    .button--disabled {
        pointer-events: none;
        opacity: 0.55;
        box-shadow: none;
    }

    @media (max-width: 980px) {
        .pharmacy-shell {
            grid-template-columns: 1fr;
        }

        .summary-card {
            position: static;
        }
    }
</style>
{% endblock %}

{% block content %}
<section class="page-head">
    <div>
        <h1 class="page-title">Farmacia</h1>
        <p class="page-subtitle">Consulta el catalogo, ajusta cantidades en tu carrito y confirma la compra con el total real y el stock validado al momento de guardar.</p>
    </div>
    <div class="button-row">
        <a class="button button--secondary" href="{% url 'nucleo:historialCompra' %}">Ver historial</a>
        <span class="pharmacy-pill">{{ cart_units }} item{{ cart_units|pluralize }}</span>
        <span class="pharmacy-pill">Total {{ cart_total }}</span>
    </div>
</section>

<section class="pharmacy-shell">
    <div class="pharmacy-stack">
        <section class="content-card pharmacy-panel">
            <div class="pharmacy-panel__head">
                <div>
                    <h2 class="dashboard-card__title">Catalogo disponible</h2>
                    <p class="pharmacy-panel__copy">Selecciona medicamentos desde el listado y el carrito se actualiza en la misma pantalla.</p>
                </div>
                <span class="pharmacy-pill">{{ medicamentos|length }} producto{{ medicamentos|length|pluralize }}</span>
            </div>

            <div class="medicine-grid">
                {% for m in medicamentos %}
                <article class="medicine-card{% if not m.stock or m.stock < 1 %} medicine-card--disabled{% endif %}">
                    <div class="medicine-card__top">
                        <div>
                            <h3 class="medicine-card__name">{{ m.nombre }}</h3>
                            <p class="medicine-card__meta">{{ m.descripcion|default:"Sin detalle disponible." }}</p>
                        </div>
                        <span class="price-tag">{{ m.precio }}</span>
                    </div>
                    <div class="medicine-card__foot">
                        {% if not m.stock or m.stock < 1 %}
                        <span class="stock-tag stock-tag--empty">Sin stock</span>
                        {% elif m.stock < 6 %}
                        <span class="stock-tag stock-tag--low">Stock bajo: {{ m.stock }}</span>
                        {% else %}
                        <span class="stock-tag">Stock: {{ m.stock }}</span>
                        {% endif %}

                        {% if m.stock and m.stock > 0 %}
                        <a class="button button--secondary button--tight" href="{% url 'nucleo:addMedicamento' pk=m.id %}">Agregar</a>
                        {% else %}
                        <span class="button button--secondary button--tight button--disabled">Agotado</span>
                        {% endif %}
                    </div>
                </article>
                {% empty %}
                <div class="empty-state">No hay medicamentos cargados.</div>
                {% endfor %}
            </div>
        </section>

        <section class="content-card pharmacy-panel">
            <div class="pharmacy-panel__head">
                <div>
                    <h2 class="dashboard-card__title">Carrito actual</h2>
                    <p class="pharmacy-panel__copy">Ajusta cantidades antes de confirmar. El stock se valida de nuevo al guardar.</p>
                </div>
                <span class="pharmacy-pill">{{ cart_lines }} linea{{ cart_lines|pluralize }}</span>
            </div>

            {% if carrito %}
            <div class="cart-list">
                {% for c in carrito %}
                <article class="cart-row">
                    <div class="cart-row__top">
                        <div>
                            <h3 class="cart-row__name">{{ c.nombre }}</h3>
                            <p class="cart-row__meta">{{ c.descripcion|default:"Sin detalle disponible." }}</p>
                        </div>
                        <span class="cart-row__qty">{{ c.cantidad }}</span>
                    </div>
                    <div class="cart-row__totals">
                        <span class="stock-tag">Unitario {{ c.precio }}</span>
                        <span class="price-tag">Subtotal {{ c.acumulado }}</span>
                    </div>
                    <div class="cart-row__actions">
                        <a class="button button--secondary button--tight button--icon" href="{% url 'nucleo:addMedicamento' pk=c.id %}">+</a>
                        <a class="button button--secondary button--tight button--icon" href="{% url 'nucleo:restarMedicamento' pk=c.id %}">-</a>
                        <a class="button button--danger button--tight" href="{% url 'nucleo:removeMedicamento' pk=c.id %}">Quitar</a>
                    </div>
                </article>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">El carrito esta vacio. Agrega productos desde el catalogo para preparar una compra.</div>
            {% endif %}
        </section>
    </div>

    <aside class="content-card summary-card">
        <div class="summary-card__head">
            <span class="summary-card__eyebrow">Confirmacion</span>
            <h2 class="summary-card__title">Resumen de compra</h2>
            <p class="summary-card__copy">El pedido se genera con la fecha actual, total recalculado y descuento real de stock por cada linea.</p>
        </div>

        <div class="summary-grid">
            <div class="summary-stat">
                <span class="summary-stat__label">Fecha</span>
                <span class="summary-stat__value">{{ purchase_date }}</span>
            </div>
            <div class="summary-stat">
                <span class="summary-stat__label">Lineas</span>
                <span class="summary-stat__value">{{ cart_lines }}</span>
            </div>
            <div class="summary-stat">
                <span class="summary-stat__label">Unidades</span>
                <span class="summary-stat__value">{{ cart_units }}</span>
            </div>
            <div class="summary-stat">
                <span class="summary-stat__label">Total</span>
                <span class="summary-stat__value summary-stat__value--total">{{ cart_total }}</span>
            </div>
        </div>

        <ul class="summary-notes">
            <li>Si un medicamento cambia de stock antes de confirmar, la compra se bloquea y el carrito no se pierde.</li>
            <li>Las lineas se guardan en el historial interno de compras con el detalle de cantidades.</li>
        </ul>

        <div class="summary-actions">
            <form method="post">
                {% csrf_token %}
                {% if carrito %}
                <button type="submit" class="button button--primary">Confirmar compra</button>
                {% else %}
                <button type="submit" class="button button--primary button--disabled" disabled>Confirmar compra</button>
                {% endif %}
            </form>

            {% if carrito %}
            <a class="button button--secondary" href="{% url 'nucleo:limpiarCarrito' %}">Vaciar carrito</a>
            {% endif %}
        </div>
    </aside>
</section>
{% endblock %}
